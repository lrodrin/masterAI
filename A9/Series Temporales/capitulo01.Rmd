---
author: "Laura Rodríguez Navas"
date: "`r format(Sys.time(), '%B, %Y')`"
documentclass: book
principal: yes
forprint: false
fontsize: 11pt
geometry: margin = 2.5cm
bibliography: bib/library.bib
metodobib: yes
biblio-style: plainnat
csl: methods-in-ecology-and-evolution.csl
link-citations: yes
output:
  html_document: 
    toc: yes
    fig_caption: yes
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib
    fig_caption: yes
    template: latex/template.tex
---


```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = 'figurasR/',
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.pos = "H",
  fig.align = "center",
  out.width = "95%",
  cache = FALSE
)
```

<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \nocite{*} -->
\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

# Análisis de la serie temporal

## Introducción

Una empresa tecnológica cuya área de negocio es la inteligencia artificial es contratada por una empresa eléctrica para que diseñe un sistema de recomendación que haga ofertas personalizadas a sus clientes sobre los paquetes energéticos más adecuados a sus consumos. Para ello, la empresa primero debe llevar a cabo un análisis exhaustivo de los consumos energéticos y diseñar una técnica de predicción que sea capaz de predecir dichos consumos con un horizonte temporal dado. La empresa eléctrica suministra a la empresa tecnológica para dicho cometido los consumos eléctricos desde el 01 de enero de 2015 hasta el 31 de diciembre de 2015 medidos con una frecuencia temporal de 10 minutos.

Se pide:

1. Analizar la serie temporal de consumos eléctricos y describir brevemente las principales características de esta.

2. Realizar un estudio para determinar si la serie temporal presenta *outliers*. Describir brevemente el estudio realizado y las conclusiones alcanzadas.

3. Seleccionar un artículo publicado en una revista científica de prestigio internacional en el que se presente un método de predicción. Estudiar de manera detallada el método publicado y describirlo de forma resumida.

4. Aplicar el método seleccionado en el apartado anterior para obtener una predicción del consumo eléctrico con un horizonte temporal de 4 horas para los días de la semana desde el lunes 8 de junio hasta el domingo 14 de junio. Para ello, se debe implementar un método de predicción en el lenguaje de programación que se estime oportuno o bien usar software libre disponible como WEKA, R, KEEL, etc. Una vez obtenidas las predicciones del periodo indicado, visualizar los resultados (predicciones, errores, etc.).

El trabajo de investigación se realiza utilizando el lenguaje de programación **R** y todos los datos y el código necesarios para reproducir el estudio se proporcionan dentro de este documento para garantizar que éste sea completamente reproducible.

Se han utilizado los siguientes paquetes para el análisis:

```{r warning=FALSE}
library(tidyverse)
library(ggplot2)
library(lubridate)
library(xts)
library(forecast)
```

## Datos de la serie temporal

Los datos están disponibles para descargar [aquí](https://github.com/lrodrin/masterAI/raw/master/A9/Series%20Temporales/Demanda_2015.csv). Una vez descargados, los cargamos en nuestro espacio de trabajo.

```{r}
data <- read.csv("Demanda_2015.csv", header = FALSE, sep = ",")
```

Para su uso posterior, el marco de datos de la serie temporal se formatea. 

TODO

```{r}
#
colnames(data) <- c("date", "time", "demand")

#
head(data, 10)

#
summary(data)
```

Tenemos la variable *date* como *character*, la variable *time* como *character* y la variable *demand* como *integer.*

```{r}
sum(is.na(data))
```


```{r warning=FALSE}
#
data <- cbind(datetime = paste(data$date, data$time), data)
data$datetime <- parse_date_time(data$datetime, "dmY HMS",
                                 truncated = 3, tz = "UTC")
#
data$date <- NULL
data$time <- NULL

#
head(data, 10)
```

## Características de la serie temporal

La siguiente figura ayuda a visualizar la evolución de la demanda a lo largo del año 2015.

```{r warning=FALSE}
# ggplot(data = data, aes(x = datetime, y = demand)) +
#   geom_line() +
#   geom_smooth(method = "loess", se = FALSE, span = 0.6) +
#   scale_x_datetime(date_labels = "%b",
#                    breaks = "1 month",
#                    expand = c(0, 0)) +
#   ggtitle("Consumo eléctrico, 2015") +
#   xlab("Mes") +
#   ylab("Demanda en MW")
```

Observando la figura se puede detectar una dependencia estacional de la demanda, aunque pueden existir otros factores que pueden afectarla, como los días festivos, los fines de semana, etc.

```{r include=FALSE}
data$month <- format(data$datetime, format = "%B")
```

Si queremos comparar mejor la distribución de la demanda de energía para cada mes, la siguiente figura es muy útil.

```{r warning=FALSE}
# ggplot(data, aes(x = datetime, y = demand)) +
#   geom_line(aes(colour = month)) +
#   geom_smooth(method = "loess", se = FALSE, span = 0.6) +
#   scale_x_datetime(date_labels = "%b",
#                    breaks = "1 month",
#                    expand = c(0, 0)) +
#   ggtitle("Consumo eléctrico, 2015") +
#   xlab("Mes") +
#   ylab("Demanda en MW") +
#   theme(legend.position = "none")
```

Durante el invierno y el verano la demanda es de manera clara mayor salvo, probablemente, en los períodos vacacionales. Como se puede observar en el mes de agosto. Podemos deducir de la figura que en sí mismos los datos siguen un patrón de subidas y caídas en una tendencia que varia sumo en los meses de invierno. Esto se debe a que las personas usan la electricidad para enfriar y calentar sus viviendas respectivamente.

```{r include=FALSE}
data$month <- NULL
```

## Componentes de la serie temporal

Es frecuente analizar las series temporales desde el punto de vista de sus componentes estructurales: *Serie observada = Tendencia + Efecto estacional + Residuos*.

Si queremos que **R** trate un objeto como una serie temporal, tenemos que determinar apropiadamente sus características con el comando *ts*. Para definir la serie correctamente escribimos:

```{r}
ts <- ts(data$demand, frequency = 24*60/10)
```

El argumento *frequency* se utiliza para indicar la periodicidad de la serie (en este caso de 10 minutos).

### Análisis de autocorrelación y autocorrelación parcial

El análisis de correlación y autocorrelación parcial se usa para examinar la dependencia de la serie. 

```{r}
acf(ts, main = "Autocorrelación")
pacf(ts, main = "Autocorrelación parcial")
```

La función de autocorrelación muestra un proceso no estacionario altamente autocorrelacionado, y destaca la estacionalidad. La función de autocorrelación parical es más diffícil de interpretar, pero debido a la forma de *tail-off*, donde los valores cada vez se van haciendo más pequeños, parece un comportamiento típico de los modelos **ARIMA**.

### Descomposición de la serie

En **R** es muy sencillo y existen diferentes opciones para obtener la descomposición estructural de la serie temporal. Por ejemplo, se puede usar la combinación de los paquetes *mstl* y *autoplot*.

A continuación se representa la descomposición de la serie temporal:

```{r}
# Múltiple estacionalidad
mstl(ts, lambda = "auto") %>% 
  autoplot(main = "Descomposición de la serie temporal")
```

Como puede verse, los datos de la serie temporal *Data* son descompuestos en:

- **Trend** o tendencia, se calcula con una media móvil. En la figura, la tendencia general de los datos varia suavemente.
- **Seasonal144**, es el efecto estacional fijado.
- **Remainder**, son los residuos de la serie, se obtienen restando a la serie temporal observada *Data* las dos componentes anteriores. En la figura, parece que existen bastantes residuos, será difícil que un modelo estacionario pueda modelar bien si no se transforma la serie temporal de manera que el modelo estacionario sea apropiado para la serie transformada.
