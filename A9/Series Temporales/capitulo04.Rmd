---
author: "Laura Rodríguez Navas"
date: "`r format(Sys.time(), '%B, %Y')`"
documentclass: book
principal: yes
forprint: false
fontsize: 11pt
geometry: margin = 2.5cm
bibliography: bib/library.bib
metodobib: yes
biblio-style: plainnat
csl: methods-in-ecology-and-evolution.csl
link-citations: yes
output:
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib
    fig_caption: yes
    template: latex/template.tex
  html_document: 
    toc: yes
    fig_caption: yes
---


```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = 'figurasR/',
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.pos = "H",
  fig.align = "center",
  out.width = "75%",
  cache = FALSE)
```

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents

\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

```{r eval=FALSE, include=FALSE}
data$date <- NULL
data$time <- NULL
data$month <- NULL
data$day <- NULL
```

# Aplicación del modelo ARIMA

## Transformación de la serie

El análisis previo del primer capítulo nos ha revelado que la serie no es estacionaria por su estacionalidad, y como el modelo que vamos a utilizar es un modelo ARIMA, necesitamos que la serie sea estacionaria. Para ello, tendremos que eliminar la estacionalidad de la serie, diferenciando la serie lograremos que se convierta en estacionaria. Para empezar la transformación de la serie, primero se observa que resultado devuelve la función *ndiffs()*, que calcula el número de diferenciaciones estacionales que se necesitan llevar a cabo para que la serie sea estacionaria.

```{r}
ndiffs(ts) 
```

El cálculo nos muestra que la serie necesita de una diferenciación estacional. Con la función *diff()* eliminaremos la estacionalidad. Compararemos el resultado gráficamente con la serie original.

```{r}
tsstationary <- diff(ts, differences = 1)
plot(ts,  main = "Serie temporal original")
plot(tsstationary, main = "Serie temporal actual")
```

Como podemos ver se ha eliminado la componente de estacionalidad en la serie, también lo podemos ver en la función de autocorrelación.

```{r}
acf(ts, main = "Autocorrelación de la serie temporal original")
acf(tsstationary, main = "Autocorrelación de la serie temporal actual")
```

Una vez eliminada la componente estacional, la serie se parece bastante a una serie estacionaria, ya que parece ser constante en media y varianza, pero para asegurarlo se aplica un test de estacionariedad como el test de Dickey-Fuller Aumentado (Augmented Dickey-Fuller Test (ADF), en inglés) y el test de Phillips–Perron (PP), una modificación de test de Dickey-Fuller. 

En estos tests, se considera que la hipótesis nula es que la serie tiene raíces unitarias, por tanto, no es estacionaria. Al contrario, la serie es estacionaria. Con un *p-value* inferior a 0.05, la hipótesis nula se rechaza, confirmando que la serie es estacionaria. El motivo de basarse en la observación de raíces unitarias es porqué una raíz unitaria, es una tendencia estocástica en la serie temporal. Algunas veces se le llama *"paseo aleatorio con deriva"*. Por tanto, si la serie tiene una raíz unitaria, ésta presenta un patrón sistemático que es impredecible. Entonces, una serie temporal es estacionaria si un cambio en el tiempo no cambia la forma de la distribución; y las raíces unitarias son una causa de no estacionalidad.

Para aplicar los tests anteriores, se usa el paquete [tseries](https://www.rdocumentation.org/packages/tseries/).

```{r warning=FALSE}
# Cargamos el paquete tseries
library(tseries)
```

Se aplica el test de Dickey-Fuller Aumentado *adf.test*:

```{r warning=FALSE}
adf.test(tsstationary)
```

Como se puede observar, después de transformar la serie, ahora sí es estacionaria; el *p-value* de 0.01, indica que rechazamos la hipótesis nula de no estacionalidad.

\newpage 

Ahora, se aplica el test de PP:

```{r warning=FALSE}
pp.test(tsstationary)
```
Con este test, también se obtiene un *p-value* de 0.01, por tanto, también rechazamos la hipótesis nula y podemos decir que la serie es estacionaria. Por último, descomponemos la serie temporal transformada:

```{r}
componentes.tsstationary <- decompose(tsstationary)
plot(componentes.tsstationary)
```
Después de analizar los anteriores tests y observar la última figura, se puede afirmar que no se observa estacionalidad en la serie transformada, es estacionaria.

## Predicción

Se aplica el método de predicción descrito en el capítulo anterior para obtener una predicción del consumo eléctrico con un horizonte temporal de 4 horas para los días de la semana desde el lunes 8 de junio hasta el domingo 14 de junio.