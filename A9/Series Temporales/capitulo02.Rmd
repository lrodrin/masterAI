---
author: "Laura Rodríguez Navas"
date: "`r format(Sys.time(), '%B, %Y')`"
documentclass: book
principal: yes
forprint: false
fontsize: 11pt
geometry: margin = 2.5cm
bibliography: bib/library.bib
metodobib: yes
biblio-style: plainnat
csl: methods-in-ecology-and-evolution.csl
link-citations: yes
output:
  html_document: 
    toc: yes
    fig_caption: yes
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib
    fig_caption: yes
    template: latex/template.tex
---


```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = 'figurasR/',
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.pos = "H",
  fig.align = "center",
  out.width = "95%",
  cache = FALSE
)
```

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents

\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

# WORKING HERE

# Búsqueda de outliers

En el capítulo anterior se ha comentado que podrían existir factores que afecten a la serie temporal. Uno de esos factores podría ser que, durante los fines de semana, el consumo eléctrico disminuya considerablemente en comparación con el resto de los días de la semana, y eso provocaría la aparición de valores atípicos en la serie temporal. Otro factor que puede hacer disminuir el consumo eléctrico considerablemente y provocar la aparición de valores atípicos en la serie temporal, son los días festivos. Así, se han considerado estos dos factores para localizar valores atípicos en la serie temporal, si es que tiene.

Primero se analiza el consumo eléctrico durante los fines de semana mediante la siguiente figura. Pero antes se añade a los datos una columna nueva *day*, para indicar los días de la semana.

```{r}
data$day <- format(data$datetime, format = "%A")
ggplot(data, aes(day, demand)) +
  geom_boxplot() +
  ggtitle("Consumos eléctricos por día de la semana del año 2015") +
  xlab("Día") +
  ylab("Consumo en MW")
```
Como se observa en la figura durante los fines de semana (sábado y domingo), la demanda disminuye considerablemente en comparación con el resto de los días de la semana y aparecen valores atípicos.

Por otro lado, ahora nos fijaremos en qué rangos se mueve la demanda del consumo eléctrico a lo largo del 2015. Se usa un histograma para que aporte esa información con un simple vistazo.

```{r}
hist(data$demand,
     main = "Frecuencia de la demanda",
     ylab = "Frecuencia",
     xlab = "Demanda")
```
La figura anterior muestra una distribución extraña para la demanda. Lo que se entiende es que:

- Hay poca frecuencia de la demanda, cuando la demanda es inferior a 20000 MW y superior a 35000 MW (aproximadamente).

- La frecuencia de la demanda es frecuente entre 20000 MW y 35000 MW.

- La baja demanda es más frecuente de lo normal dentro de conjunto de datos de la serie temporal, parece que predominan bastantes valores atípicos.

## INVENT

```{r}

breakPoints <- c(0, 24392, 31664, Inf)
categories <- c("Low", "Medium", "High")
data$demand.F <- cut(data$demand, breaks = breakPoints, labels = categories)
demand_low <- data[data$demand.F == "Low", ] 
demand_low2 <- demand_low[demand_low$day != "dissabte" & demand_low$day != "diumenge", ] 
dates <- as.Date(demand_low2$date, format = '%d/%m/%Y')
dates_unique <- unique(dates)
dates_unique

```
los high pasamos de explicar que date son. ya hay suficientes ejemplos.
explicar quartiles y reemplazo de outliers en R.

```{r}
plot(data$demand)
```



```{r}
summary(data$demand)
datarm <- data[data$demand.F != "Low",]
summary(datarm)
```

En el apartado siguiente, se identificarán y remplazarán los valores atípicos de la demanda. Porqué las futuras predicciones derivadas de los conjuntos de datos de series temporales que incluyen valores atípicos frecuentemente son engañosas.

## Reemplazo de outliers

Para reemplazar los *outliers*, se necesitan dos umbrales. Como se ha comentado, se opta por el reemplazo. No se opta por la eliminación de los valores atípicos para no perder datos representativos de la serie. La eliminación de bastantes datos representativos de la serie puede tener un impacto negativo en las futuras predicciones de la serie. Los umbrales que se definirán indicarán qué valores de la demanda serán reemplazados.

Se usa la función *summary()*, que nos devolverá información sobre los cuartiles de la demanda. Los cuartiles son valores que dividen el conjunto de datos de la serie temporal en diferentes partes. Estos se utilizarán para definir los umbrales.

```{r}
summary(data$demand)
```
En el reemplazo que nos traemos entre manos, se observa que el primer cuartil (*Q1*) está en 24392 MW y que el tercer cuartil (*Q3*) está en 31664 MW. El uso de los cuartiles en el reemplazo se debe a que entre *Q1* y *Q3* sabemos que se encuentran el 50% de los valores de la serie. La distancia entre los valores de *Q1* y *Q3* se le llama rango intercuantílico (*IQR: InterQuantile Range*). En este caso, el valor de *IQR* es:

```{r}
IQR <- 31664 - 24392
IQR
```

Así según los cuartiles sobre la demanda, se define como valor atípico leve aquel que dista 1.5 veces el rango intercuantílico por debajo de *Q1* o por encima de *Q3.*

\begin{center}
  *outlier* < Q1 - 1.5 * IQR o bien *outlier* > Q3 + 1.5 * IQR
\end{center}

y valor atípico extremo aquel que dista 3 veces el rango intercantílico por debajo de *Q1* o por encima de *Q3*.

\begin{center}
  *outlier* < Q1 - 3 * IQR o bien *outlier* > Q2 + 3 * IQR
\end{center}

De hecho, con esta información, se calculan los umbrales *highLimit* y *lowLimit*, de la siguiente manera:

```{r}
highLimit <- 24392 + 1.5 * IQR
highLimit
lowLimit <- 31664 - 1.5 * IQR
lowLimit
```

Concretamente, todos los valores de la demanda que superen los 35300 MW se consideran *outliers*. Y todos los valores de la demanda que sean inferiores a los 20756 MW también son *outliers*.

Una vez que se han identificado los *outliers* de la demanda, se procede al reemplazo de estos. Para ello, se define una función propia que recibe como parámetros el conjunto de datos de la demanda, el umbral inferior y el umbral superior. En la función se decide reemplazar por la media aquellos valores atípicos que estén por debajo del umbral inferior, y por la mediana aquellos que estén por encima del umbral superior, procedimiento muy utilizado en el reemplazo de *outliers*.

La función y su aplicación se muestran a continuación:

```{r}
outliersReplace <- function(data, lowLimit, highLimit) {
  data[data < lowLimit] <- as.integer(mean(data))
  data[data > highLimit] <- as.integer(median(data))
  data
}

data$demand.WO <- outliersReplace(data$demand, lowLimit, highLimit)
```
Veamos dos ejemplos donde se ha realizado el reemplazo.

```{r}
data[752, c("demand", "demand.WO")]
data[1666, c("demand", "demand.WO")]
```

Finalmente, substituiremos los valores de la demanda originales por los valores de la demanda sin *outliers*.
```{r}
data$demand <- data$demand.WO
summary(data$demand)
```

Es normal que la media, o la mediana o los cuartiles cambien después del reemplazo, pues los *outliers* tenían bastante peso y distorsionaban los datos de la serie.