---
author: "Laura Rodríguez Navas"
date: "`r format(Sys.time(), '%B, %Y')`"
documentclass: book
principal: yes
forprint: false
fontsize: 11pt
geometry: margin = 2.5cm
bibliography: bib/library.bib
metodobib: yes
biblio-style: plainnat
csl: methods-in-ecology-and-evolution.csl
link-citations: yes
output:
  html_document: 
    toc: yes
    fig_caption: yes
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib
    fig_caption: yes
    template: latex/template.tex
---


```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = 'figurasR/',
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.pos = "H",
  fig.align = "center",
  out.width = "95%",
  cache = FALSE
)
```

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents

\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

# WORKING HERE

# Búsqueda de outliers

Se utilizan los siguientes paquetes para la búsqueda de *outliers*:

```{r}
```

En el capítulo anterior se ha comentado que podrían existir factores que afecten a la serie temporal. Uno de esos factores podría ser que, durante los fines de semana, el consumo eléctrico disminuya considerablemente en comparación con el resto de los días de la semana, y eso provocaría la aparición de valores atípicos en la serie temporal. Otro factor que puede hacer disminuir el consumo eléctrico considerablemente y provocar la aparición de valores atípicos en la serie temporal, son los días festivos. Así, se han considerado estos dos factores para localizar valores atípicos en la serie temporal, si es que tiene.

Primero se analiza el consumo eléctrico durante los fines de semana mediante la siguiente figura. Pero antes se añade a los datos una columna nueva *day*, para indicar los días de la semana.

```{r}
data$day <- format(data$datetime, format = "%A")
ggplot(data, aes(day, demand)) +
  geom_boxplot() +
  ggtitle("Consumos eléctricos por día de la semana del año 2015") +
  xlab("Día") +
  ylab("Consumo en MW")
```
Como se observa en la figura durante los fines de semana (sábado y domingo), la demanda disminuye considerablemente en comparación con el resto de los días de la semana y aparecen valores atípicos.

Por otro lado, ahora nos fijaremos en qué rangos se mueve la demanda del consumo eléctrico a lo largo del 2015. Se usa un histograma para que aporte esa información con un simple vistazo.

```{r}
hist(data$demand,
     main = "Frecuencia de la demanda",
     ylab = "Frecuencia",
     xlab = "Demanda")
```
La figura anterior muestra una distribución extraña para la demanda. Lo que se entiende es que:

- Hay poca frecuencia de la demanda, cuando la demanda es inferior a 20000 MW y superior a 35000 MW (aproximadamente).

- La frecuencia de la demanda es frecuente entre 20000 MW y 35000 MW.

- La baja demanda es más frecuente de lo normal dentro de conjunto de datos de la serie temporal, parece que predominan bastantes valores atípicos.

## Reemplazo de outliers

A continuación, se definirán los umbrales para reemplazar los valores atípicos de la serie temporal. Estos umbrales indicarán qué valores de la demanda serán reemplazados por la la mediana (que en este caso podría ser más representativa). Para ello, usaremos la función *summary()*.

```{r}
summary(data$demand)
```
Comprobamos que la mediana es más representativa que la media. 

En el ejemplo que nos traemos entre manos, vemos que Q1 está en 24392 MW y que Q3 está en 31664 MW. Entre Q1 y Q3 sabemos que están el 50% de los valores obtenidos en el estudio. A esta distancia se le llama rango intercuantílico (IQR: InterQuantile Range).

IQR = Q3 - Q1 = 31664 - 24392 = 7272 MW

```{r}
IQR <- 31664 - 24392
IQR
```

Se define como valor atípico leve aquel que dista 1,5 veces el rango intercuantílico por debajo de Q1 o por encima de Q3.

*q* < Q1 - 1.5 * IQR o bien *q* > Q3 + 1.5 * IQR

y valor atípico extremo aquel que dista 3 veces el rango intercantílico por debajo de Q1 o por encima de Q3.

*q* < Q1 - 3 * IQR o bien *q* > Q2 + 3 * IQR

De hecho, sospechando que hay *outliers*, vamos a calcular cual serían los umbrales:

```{r}
highLimit <- 24392 + 1.5 * IQR
lowLimit <- 31664 - 1.5 * IQR
highLimit
lowLimit
```

Todos los valores del muestro que superen 35300 son outliers. De ahí para arriba, está muy por encima y se consideran valores atípicos.


Todos los valores del muestro que sean inferiores a 20756 son outliers. De ahí para abajo, está muy por debajo y se consideran valores atípicos.

Nos definimos nuestra propia función que recibe como parámetros el conjunto de datos, el umbral inferior y el umbral superior. Y en la función decidimos reemplazar por la media aquellos valores atípicos que estén por debajo del umbral inferior, y por la mediana aquellos que estén por encima del umbral superior.

```{r}
# reemplazo de outliers con R
outliersReplace <- function(data, lowLimit, highLimit){
  data[data < lowLimit] <- mean(data)
  data[data > highLimit] <- median(data)
  data           
}

data$demand.WO <- outliersReplace(data$demand, lowLimit, highLimit)

summary(data$demand)
summary(data$demand.WO)
```


## INVENT

Es normal que la media, mediana y cuartiles hayan cambiado, pues los outliers tenían mucho peso y distorsionaban los datos. Aún así, este muestreo que es un subconjunto del original, tiene pinta que no está bien balanceado y tendrá sus propios outliers. No hay más que ver la distancia que hay por encima del Q3.

```{r}

breakPoints <- c(0, 24392, 31664, Inf)
categories <- c("Low", "Medium", "High")
data$demand.F <- cut(data$demand, breaks = breakPoints, labels = categories)
demand_low <- data[data$demand.F == "Low", ] 
demand_low2 <- demand_low[demand_low$day != "dissabte" & demand_low$day != "diumenge", ] 
dates <- as.Date(demand_low2$date, format = '%d/%m/%Y')
dates_unique <- unique(dates)
dates_unique

```
los high pasamos de explicar que date son. ya hay suficientes ejemplos.
explicar quartiles y reemplazo de outliers en R.

```{r}
plot(data$demand)
```



```{r}
summary(data$demand)
datarm <- data[data$demand.F != "Low",]
summary(datarm)
```