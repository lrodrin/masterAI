---
author: "Laura Rodríguez Navas"
date: "`r format(Sys.time(), '%B, %Y')`"
documentclass: book
principal: yes
forprint: false
fontsize: 11pt
geometry: margin = 2.5cm
bibliography: bib/library.bib
metodobib: yes
biblio-style: plainnat
csl: methods-in-ecology-and-evolution.csl
link-citations: yes
output:
  html_document: 
    toc: yes
    fig_caption: yes
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib
    fig_caption: yes
    template: latex/template.tex
---


```{r include=FALSE}
knitr::opts_chunk$set(
  fig.path = 'figurasR/',
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.pos = "H",
  fig.align = "center",
  out.width = "80%",
  cache = FALSE
)
```

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents

\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

# Outliers

## Identificación de outliers

En el capítulo anterior se ha comentado que podrían existir factores que afecten a la serie temporal. Uno de esos factores podría ser que, durante los fines de semana, el consumo eléctrico disminuya considerablemente en comparación con el resto de los días de la semana, y eso provocaría la aparición de valores atípicos en la serie temporal. Otro factor que puede hacer disminuir el consumo eléctrico considerablemente y provocar la aparición de valores atípicos en la serie temporal, son los días festivos. Así, se han considerado estos dos factores para localizar valores atípicos en la serie temporal, si es que tiene. Primero se analiza el consumo eléctrico durante los fines de semana mediante la siguiente figura. Pero antes se añade a los datos una columna nueva *day*, para indicar los días de la semana.

```{r}
data$day <- format(data$datetime, format = "%A")
ggplot(data, aes(day, demand)) +
  geom_boxplot() +
  ggtitle("Consumos eléctricos por día de la semana del año 2015") +
  xlab("Día") + ylab("Consumo en MW")
```
Como se observa en la figura durante los fines de semana (sábado y domingo), la demanda disminuye considerablemente en comparación con el resto de los días de la semana y aparecen valores atípicos. Por otro lado, ahora nos fijaremos en qué rangos se mueve la demanda del consumo eléctrico a lo largo del 2015. Se usa un histograma para que aporte esa información con un simple vistazo.

```{r}
hist(data$demand,
     main = "Frecuencia de la demanda",
     ylab = "Frecuencia",
     xlab = "Demanda")
```
La figura anterior muestra una distribución extraña para la demanda.

- Hay poca frecuencia de la demanda, cuando la demanda es inferior a 22000 MW y superior a 34000 MW (aproximadamente).

- La frecuencia de la demanda es frecuente entre 22000 MW y 34000 MW.

- La baja demanda es más frecuente de lo normal dentro de conjunto de datos de la serie temporal, parece que predominan bastantes valores atípicos.

Después de este breve análisis, es interesante estudiar cuantos valores atípicos hay en la demanda. Para ello, el primer paso es convertir la variable demanda *demand*, una variable numérica en categórica. Se define la siguiente categorización, basándonos en el histograma, que a priori parece razonable:

- hasta 21000 MW la demanda es baja (*low*).

- de 21000 a 34000 MW la demanda no se consideraría un valor atípico (*medium*).

- mayor de 34000 MW la demanda es muy alta (*high*).

```{r}
breakPoints <- c(0, 22000, 34000, Inf)
categories <- c("low", "medium", "high")
data$demand.C <- cut(data$demand, breaks = breakPoints, labels = categories)
summary(data$demand.C)
```

Con esta categorización, podríamos decir que en la serie existen aproximadamente 10972 valores atípicos (4453 + 6519). Esta cantidad es bastante alta, y en ese caso sería recomendable aplicar un método de reemplazo de estos valores atípicos que parece que se encuentran fuera del rango medio de la demanda. Además, como curiosidad, antes de reemplazar los *outliers* de la serie, analizaremos si muchos de estos valores atípicos pertenecen a días festivos, fines de semana o días en períodos de vacaciones, como parece que hemos detectado en nuestro primer análisis.

```{r}
demand.low <- data[data$demand.C == "low", ]
table(demand.low$day)
demand.high <- data[data$demand.C == "high", ]
table(demand.high$day)
```
Se puede observar que los días de menos demanda eléctrica son los fines de semana. Contrariamente los días de más demanda eléctrica son días entre semana. Pero se observa un dato extraño, hay muchos lunes donde la demanda es baja. Esto seguramente se debe a que bastantes [días festivos del año 2015](https://www.calendario-365.es/dias-festivos/2015.html) fueron un lunes. 

```{r}
demand.monday <- demand.low[demand.low$day == "lunes", ] 
sort(table(demand.monday$date))
```
Observamos que la afirmación anterior es verdad y vemos algunos ejemplos:

- 12/10/2015: Día de la Hispanidad.

- 06/04/2015: Lunes de Pascua.

- 26/10/2015: Esta fecha es muy interesante, ya que coincide que es el día después del cambio de hora (horario de invierno).

- 09/11/2015: Almudena (sólo en Madrid).

- 28/12/2015: en período vacacional de Navidades.

En el apartado siguiente, se remplazarán los valores atípicos de la demanda. Porqué para la futura predicción del capítulo cuatro, si el conjunto de datos de la serie incluye bastantes valores atípicos la predicción será engañosa.

## Reemplazo de outliers

Para reemplazar los *outliers*, se necesitan dos umbrales. Como se ha comentado, se opta por el reemplazo. No se opta por la eliminación de los valores atípicos para no perder datos representativos de la serie. La eliminación de bastantes datos representativos de la serie puede tener un impacto negativo en las futuras predicciones de la serie. Los umbrales que se definirán indicarán qué valores de la demanda serán reemplazados.

Se usa la función *summary()*, que nos devolverá información sobre los cuartiles de la demanda. Los cuartiles son valores que dividen el conjunto de datos de la serie temporal en diferentes partes. Estos se utilizarán para definir los umbrales.

```{r}
summary(data$demand)
```
En el reemplazo que nos traemos entre manos, se observa que el primer cuartil (*Q1*) está en 24392 MW y que el tercer cuartil (*Q3*) está en 31664 MW. El uso de los cuartiles en el reemplazo se debe a que entre *Q1* y *Q3* sabemos que se encuentran el 50% de los valores de la serie. La distancia entre los valores de *Q1* y *Q3* se le llama rango intercuantílico (*IQR: InterQuantile Range*). En este caso, el valor de *IQR* es:

```{r}
IQR <- 31664 - 24392
IQR
```

Así según los cuartiles sobre la demanda, se define como valor atípico leve aquel que dista 1.5 veces el rango intercuantílico por debajo de *Q1* o por encima de *Q3*

\begin{center}
  *outlier* < Q1 - 1.5 * IQR o bien *outlier* > Q3 + 1.5 * IQR
\end{center}

y valor atípico extremo aquel que dista 3 veces el rango intercantílico por debajo de *Q1* o por encima de *Q3*

\begin{center}
  *outlier* < Q1 - 3 * IQR o bien *outlier* > Q2 + 3 * IQR
\end{center}

De hecho, con esta información, se calculan los umbrales *highLimit* y *lowLimit*:

```{r}
highLimit <- 24392 + 1.5 * IQR
highLimit
lowLimit <- 31664 - 1.5 * IQR
lowLimit
```

Vemos que todos los valores de la demanda que superen los 35300 MW se consideran *outliers*. Y todos los valores de la demanda que sean inferiores a los 20756 MW también son *outliers*. Una vez identificados los *outliers* de la demanda, se procede al reemplazo de estos. Para ello, se define una función propia que recibe como parámetros el conjunto de datos de la demanda, el umbral inferior y el umbral superior. En la función se decide reemplazar por la media aquellos valores atípicos que estén por debajo del umbral inferior, y por la mediana aquellos que estén por encima del umbral superior, procedimiento muy utilizado en el reemplazo de *outliers*. La función y su aplicación se muestran a continuación:

```{r}
outliersReplace <- function(data, lowLimit, highLimit) {
  data[data < lowLimit] <- as.integer(mean(data))
  data[data > highLimit] <- as.integer(median(data))
  data
}

data$demand.WO <- outliersReplace(data$demand, lowLimit, highLimit)
```
Veamos dos ejemplos donde se ha realizado el reemplazo.

```{r}
data[752, c("demand", "demand.WO")]
data[1666, c("demand", "demand.WO")]
```

\newpage 

Finalmente, substituiremos los valores de la demanda originales por los valores de la demanda sin *outliers*.

```{r}
data$demand <- data$demand.WO
summary(data$demand)
```

Es normal que la media, o la mediana o los cuartiles cambien después del reemplazo, pues los *outliers* tenían bastante peso y distorsionaban los datos de la serie.

```{r warning=FALSE}
# Borrado de variables temporales para ahorrar espacio
data$date <- NULL
data$time <- NULL
data$month <- NULL
data$day <- NULL
data$demand.C <- NULL
data$demand.WO <- NULL
rm(
  list = c(
    "breakPoints",
    "categories",
    "demand.high",
    "demand.low",
    "demand.monday",
    "IQR",
    "highLimit",
    "lowLimit"
  )
)
```

